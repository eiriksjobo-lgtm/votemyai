<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoteMyAI ‚Äì AI Music Voting Platform</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;500;700&display=swap" rel="stylesheet">

  
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #111118;
      --border: #1e1e2e;
      --accent: #e8ff47;
      --text: #f0f0f0;
      --muted: #666680;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; line-height: 1.6; }
    
    nav { position: sticky; top: 0; background: rgba(10,10,15,0.95); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); padding: 0 40px; height: 64px; display: flex; align-items: center; justify-content: space-between; z-index: 100; }
    .logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 2px; color: var(--accent); }
    .nav-links { display: flex; gap: 32px; align-items: center; }
    .nav-links a { color: var(--muted); text-decoration: none; font-size: 0.8rem; font-weight: 500; letter-spacing: 1px; text-transform: uppercase; transition: color 0.2s; }
    .nav-links a:hover { color: var(--text); }
    .btn-submit { background: var(--accent); color: #0a0a0f; padding: 10px 20px; border-radius: 6px; border: none; font-weight: 700; cursor: pointer; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; }
    
    .hero { text-align: center; padding: 120px 40px 80px; max-width: 900px; margin: 0 auto; }
    .hero h1 { font-family: 'Bebas Neue', sans-serif; font-size: clamp(3rem, 8vw, 5rem); letter-spacing: 2px; line-height: 1.1; margin-bottom: 20px; }
    .hero .accent { color: var(--accent); }
    .hero p { color: var(--muted); font-size: 1.1rem; margin-bottom: 40px; }
    
    .tracks-section { max-width: 1200px; margin: 0 auto; padding: 60px 40px; }
    .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; letter-spacing: 1px; margin-bottom: 32px; text-transform: uppercase; }
    
    .genre-filters { display: flex; gap: 12px; margin-bottom: 32px; flex-wrap: wrap; }
    .genre-btn { background: rgba(232,255,71,0.1); border: 1px solid rgba(232,255,71,0.3); color: var(--accent); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s; }
    .genre-btn:hover { background: rgba(232,255,71,0.2); }
    .genre-btn.active { background: var(--accent); color: #0a0a0f; }
    
    .tracks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px; }
    
    .leaderboard-section { max-width: 800px; margin: 0 auto; padding: 60px 40px; }
    .leaderboard { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .lb-row { display: flex; align-items: center; gap: 20px; padding: 16px 20px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
    .lb-row:last-child { border-bottom: none; }
    .lb-row:hover { background: rgba(232,255,71,0.05); }
    .lb-rank { font-family: 'Bebas Neue', sans-serif; font-size: 1.5rem; color: var(--accent); width: 40px; text-align: center; }
    .lb-rank.top3 { color: var(--accent); }
    .lb-info { flex: 1; }
    .lb-title { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
    .lb-meta { color: var(--muted); font-size: 0.85rem; }
    .lb-votes { font-weight: 700; color: var(--accent); font-size: 1.1rem; }
    
    footer { background: var(--surface); border-top: 1px solid var(--border); padding: 40px 20px; margin-top: 80px; }
    .footer-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
    .footer-links { display: flex; gap: 24px; flex-wrap: wrap; }
    .footer-links a { color: var(--muted); text-decoration: none; font-size: 0.85rem; transition: color 0.2s; }
    .footer-links a:hover { color: var(--text); }
    .footer-copy { color: var(--muted); font-size: 0.85rem; }
    
    .track-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: transform 0.2s; }
    .track-card:hover { transform: translateY(-4px); }
    .track-video { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; }
    .track-video iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
    .track-info { padding: 20px; }
    .track-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; }
    .track-meta { color: var(--muted); font-size: 0.85rem; margin-bottom: 16px; }
    .vote-btn { background: rgba(232,255,71,0.1); border: 1px solid rgba(232,255,71,0.3); color: var(--accent); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; width: 100%; }
    .vote-btn:hover { background: rgba(232,255,71,0.2); }
    .vote-btn.voted { background: var(--accent); color: #0a0a0f; cursor: default; opacity: 0.8; }
    .vote-btn:disabled { cursor: not-allowed; }
    .votes-count { text-align: center; margin-top: 8px; color: var(--accent); font-weight: 700; font-size: 1.2rem; }
    
    .comments-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .comments-toggle { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.85rem; padding: 4px 0; }
    .comments-toggle:hover { color: var(--text); }
    .comments-list { margin-top: 12px; display: none; }
    .comments-list.show { display: block; }
    .comment { padding: 8px 0; border-bottom: 1px solid rgba(30,30,46,0.5); }
    .comment:last-child { border-bottom: none; }
    .comment-author { font-weight: 500; font-size: 0.75rem; margin-top: 4px; color: var(--muted); font-style: italic; }
    .comment-text { font-size: 0.85rem; color: var(--text); }
    .comment-input { width: 100%; background: rgba(30,30,46,0.5); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 6px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; margin-top: 8px; }
    .comment-btn { background: var(--accent); color: #0a0a0f; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600; margin-top: 8px; }
  </style>
</head>
<body>

<nav>
  <div class="logo">VOTEMYAI</div>
  <div class="nav-links">
    <a href="#tracks">Tracks</a>
    <a href="/login.html">Login</a>
    <button class="btn-submit" onclick="window.location.href='/login.html'">Submit Track</button>
  </div>
</nav>

<div class="hero">
  <h1>VOTE<br><span class="accent">THE</span><br>FUTURE</h1>
  <p>Submit your AI-generated tracks. The community votes. The best rise to the top.</p>
</div>

<div class="tracks-section" id="tracks">
  <div class="section-title">üî• Trending Tracks</div>
  
  <div class="genre-filters">
    <button class="genre-btn active" onclick="filterGenre('all')">All</button>
    <button class="genre-btn" onclick="filterGenre('Electronic')">üéπ Electronic</button>
    <button class="genre-btn" onclick="filterGenre('Hip-Hop')">üé§ Hip-Hop</button>
    <button class="genre-btn" onclick="filterGenre('Pop')">üéµ Pop</button>
    <button class="genre-btn" onclick="filterGenre('Rock')">üé∏ Rock</button>
    <button class="genre-btn" onclick="filterGenre('Cinematic')">üé¨ Cinematic</button>
    <button class="genre-btn" onclick="filterGenre('Other')">‚ú® Other</button>
  </div>
  
  <div class="tracks-grid" id="tracksGrid">
    <p style="color: var(--muted); grid-column: 1/-1; text-align: center; padding: 60px;">Loading tracks...</p>
  </div>
</div>

<div class="leaderboard-section">
  <div class="section-title">üèÜ Top 10 Leaderboard</div>
  <div class="leaderboard" id="leaderboard">
    <p style="color: var(--muted); text-align: center; padding: 40px;">Loading...</p>
  </div>
</div>

<script type="module">
  const SUPABASE_URL = 'https://gezijezmsecbtzytotax.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_hOOMtCz7gYsu_-CVD6lW9Q_SxtFlNhw';
  
  let currentUser = null;
  let userVotes = [];
  let allTracks = [];
  let currentGenre = 'all';  
  // Check if user is logged in
  async function checkAuth() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const accessToken = params.get('access_token');
    
    if (accessToken) {
      const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
        headers: { 'Authorization': `Bearer ${accessToken}`, 'apikey': SUPABASE_KEY }
      });
      if (res.ok) {
        currentUser = await res.json();
        localStorage.setItem('sb_token', accessToken);
        window.location.hash = '';
      }
    } else {
      const token = localStorage.getItem('sb_token');
      if (token) {
        const res = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
          headers: { 'Authorization': `Bearer ${token}`, 'apikey': SUPABASE_KEY }
        });
        if (res.ok) currentUser = await res.json();
      }
    }
    
    if (currentUser) {
      await loadUserVotes();
      updateNavAuth();
    }
  }
  
  function updateNavAuth() {
    const loginLink = document.querySelector('.nav-links a[href="/login.html"]');
    if (currentUser && loginLink) {
      loginLink.textContent = currentUser.user_metadata?.name || 'Profile';
      loginLink.href = '/profile.html';
    }
  }
  
  async function loadUserVotes() {
    if (!currentUser) return;
    const token = localStorage.getItem('sb_token');
    const res = await fetch(`${SUPABASE_URL}/rest/v1/votes?user_id=eq.${currentUser.id}&select=track_id`, {
      headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${token}` }
    });
    if (res.ok) {
      const votes = await res.json();
      userVotes = votes.map(v => v.track_id);
    }
  }
  
  async function loadTracks() {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/tracks?select=*&order=votes.desc`, {
        headers: { 'apikey': SUPABASE_KEY }
      });
      allTracks = await res.json();
      renderTracks();
      renderLeaderboard();
    } catch (err) {
      console.error('Error:', err);
    }
  }
  
  function renderTracks() {
    const grid = document.getElementById('tracksGrid');
    const filteredTracks = currentGenre === 'all' 
      ? allTracks 
      : allTracks.filter(t => t.genre === currentGenre);
    
    if (!filteredTracks || filteredTracks.length === 0) {
      grid.innerHTML = '<p style="color: var(--muted); grid-column: 1/-1; text-align: center; padding: 60px;">No tracks in this genre yet!</p>';
      return;
    }
    
    grid.innerHTML = filteredTracks.map(track => {
      const anonVotes = JSON.parse(localStorage.getItem('anon_votes') || '[]');
      const hasVoted = userVotes.includes(track.id) || anonVotes.includes(track.id);
      const btnClass = hasVoted ? 'vote-btn voted' : 'vote-btn';
      const btnText = hasVoted ? '‚úì Voted' : '‚ñ≤ Vote';
      const btnDisabled = hasVoted ? 'disabled' : '';
      
      return `
        <div class="track-card">
          <div class="track-video">
            <iframe src="https://www.youtube.com/embed/${track.yt_id}" allowfullscreen></iframe>
          </div>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-meta">${track.tool} ‚Ä¢ ${track.genre}</div>
            <button class="${btnClass}" onclick="vote('${track.id}')" ${btnDisabled}>${btnText}</button>
            <div class="votes-count">${track.votes || 0} votes</div>
            <div class="comments-section">
              <button class="comments-toggle" onclick="toggleComments('${track.id}')">üí¨ Comments</button>
              <div class="comments-list" id="comments-${track.id}">
                <div id="comments-content-${track.id}">Loading...</div>
                ${currentUser ? `
                  <input type="text" class="comment-input" id="comment-input-${track.id}" placeholder="Add a comment...">
                  <button class="comment-btn" onclick="addComment('${track.id}')">Post</button>
                ` : '<p style="font-size:0.8rem;color:var(--muted);margin-top:8px;">Log in to comment</p>'}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }
  
  function renderLeaderboard() {
    const lb = document.getElementById('leaderboard');
    const top10 = [...allTracks].sort((a, b) => (b.votes || 0) - (a.votes || 0)).slice(0, 10);
    
    if (top10.length === 0) {
      lb.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 40px;">No tracks yet!</p>';
      return;
    }
    
    lb.innerHTML = top10.map((track, i) => {
      const rank = i + 1;
      const medals = ['ü•á', 'ü•à', 'ü•â'];
      const displayRank = rank <= 3 ? medals[i] : `#${rank}`;
      
      return `
        <div class="lb-row">
          <div class="lb-rank ${rank <= 3 ? 'top3' : ''}">${displayRank}</div>
          <div class="lb-info">
            <div class="lb-title">${track.title}</div>
            <div class="lb-meta">${track.tool} ‚Ä¢ ${track.genre}</div>
          </div>
          <div class="lb-votes">${track.votes || 0} votes</div>
        </div>
      `;
    }).join('');
  }
  
  window.filterGenre = function(genre) {
    currentGenre = genre;
    document.querySelectorAll('.genre-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    renderTracks();
  };
  
  window.toggleComments = async function(trackId) {
    const list = document.getElementById(`comments-${trackId}`);
    if (!list.classList.contains('show')) {
      list.classList.add('show');
      await loadComments(trackId);
    } else {
      list.classList.remove('show');
    }
  };
  
  async function loadComments(trackId) {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/comments?track_id=eq.${trackId}&select=*&order=created_at.desc`, {
        headers: { 'apikey': SUPABASE_KEY }
      });
      const comments = await res.json();
      
      const content = document.getElementById(`comments-content-${trackId}`);
      content.innerHTML = comments.length ? comments.map(c => `
        <div class="comment">
          <div class="comment-text">${c.content}</div>
          <div class="comment-author">‚Äî ${c.author_name || 'Anonymous'}</div>
        </div>
      `).join('') : '<p style="font-size:0.8rem;color:var(--muted);">No comments yet</p>';
    } catch (err) {
      console.error('Load comments error:', err);
    }
  }
  
  window.addComment = async function(trackId) {
    const input = document.getElementById(`comment-input-${trackId}`);
    const content = input.value.trim();
    if (!content) return;
    
    const token = localStorage.getItem('sb_token');
    if (!token || !currentUser) {
      alert('Please log in to comment');
      return;
    }
    
    const authorName = currentUser.user_metadata?.name || currentUser.email?.split('@')[0] || 'Anonymous';
    
    try {
      await fetch(`${SUPABASE_URL}/rest/v1/comments`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
          track_id: trackId, 
          user_id: currentUser.id, 
          content,
          author_name: authorName
        })
      });
      
      input.value = '';
      await loadComments(trackId);
    } catch (err) {
      console.error('Add comment error:', err);
    }
  };
  
  window.vote = async function(trackId) {
    // Track votes in localStorage for anonymous users
    const anonVotes = JSON.parse(localStorage.getItem('anon_votes') || '[]');
    
    if (anonVotes.includes(trackId)) {
      alert('You already voted for this track!');
      return;
    }
    
    try {
      // Increment vote count
      await fetch(`${SUPABASE_URL}/rest/v1/rpc/increment_votes`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ track_id: trackId })
      });
      
      // Save vote locally
      anonVotes.push(trackId);
      localStorage.setItem('anon_votes', JSON.stringify(anonVotes));
      
      if (currentUser) {
        // Also save to database if logged in
        const token = localStorage.getItem('sb_token');
        await fetch(`${SUPABASE_URL}/rest/v1/votes`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify({ user_id: currentUser.id, track_id: trackId })
        });
        userVotes.push(trackId);
      }
      
      await loadTracks();
    } catch (err) {
      console.error('Vote error:', err);
      alert('Failed to vote. Please try again.');
    }
  };
  
  checkAuth().then(loadTracks);
</script>

<footer>
  <div class="footer-content">
    <div class="footer-copy">¬© 2026 VoteMyAI. All rights reserved.</div>
    <div class="footer-links">
      <a href="/contact.html">Contact</a>
      <a href="/terms.html">Terms</a>
      <a href="/privacy.html">Privacy</a>
    </div>
  </div>
</footer>

</body>
</html>
